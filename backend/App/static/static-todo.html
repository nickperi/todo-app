<!doctype html>
<html>
  <head>
  
     <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!--Let browser know website is optimized for mobile-->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>App Users</title>

  </head>
  <body>
    <nav class="purple">
      <div class="nav-wrapper">
        <a href="#!" class="brand-logo center">View To-do</a>
        <div class="nav-wrapper">
            <ul id="nav-mobile" class="left">
                <li><a href="/">Home</a></li>
                <li><a href="/users">Add Users</a></li>
                <li><a href="/static/todos">View Tasks</a></li>
            </ul>
        </div>
      </div>
    </nav>
    
    <div class="container" id="content">
        <div class="row">
            <p>
                This is table is rendered on the Client. JavaScript code requests the data from <a href="/api/todos">/api/todos</a> and writes it to this page.
            </p>
        </div>
        <div class="row">
            <table>
                <thead>
                  <tr>
                    <th>Title</th><th>Edit Title</th><th>Category</th><th>Edit Category</th><th>Date Due</th><th>Done</th><th>Mark as Done</th><th>Date Completed</th><th>Time Taken</th>
                  </tr>
                </thead>
                <tbody id="result">
                
                <tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
    <script>
  async function getData() {
    const response = await fetch('/api/todos');
    return response.json();
}

    const categoryColors = {
        work:'#0D6EFD', 
        personal:'#198754', 
        urgent:'#DC3545', 
        reminder:'#ff6600ef', 
        school: "#a3118bff",
        shopping: "#E91E63", 
        other: "#9E9E9E"
    };

function loadTable(todos) {
    const table = document.querySelector('#result');
    table.innerHTML = "";

    for(let todo of todos){
        const tableRow = document.createElement('tr');
        tableRow.innerHTML += `
            <td id="task-${todo.id}-input">${todo.text}</td>
            <td id="edit-button-${todo.id}"><a style="color: orangered;" class="material-symbols-outlined" onclick="makeTaskEditable('${todo.id}')">edit</a></td>
            
            <td id="task-${todo.id}-category">
              <span class="task-badge" style="background-color: ${categoryColors[todo.category]};">${todo.category}</span> 
              
                <div id="category-dropdown-${todo.id}" style="display: none;">
                  <select id="task-${todo.id}-category-dropdown" disabled value="${todo.category}"> 
                    <option id="personal" value="personal">Personal</option>
                    <option id="work" value="work">Work</option>
                    <option id="school" value="school">School</option>
                    <option id="shopping" value="shopping">Shopping</option>
                    <option id="urgent" value="urgent">Urgent</option>
                    <option id="reminder" value="reminder">Reminder</option>
                    <option id="other" value="other">Other</option>
                  </select> 
              </div>

            </td>

            <td id="enable-categories-${todo.id}"><a style="color: magenta;" class="material-symbols-outlined" onclick="enableCategoryDropdown('${todo.id}')">edit</a></td>`;

        if(todo.date_due) {
            tableRow.innerHTML += `<td>${todo.date_due}</td>`;
        }
        else {
             tableRow.innerHTML += `<td>_</td>`;
        }

        if(todo.done) {
          tableRow.innerHTML += `
            <td id="done-${todo.id}">Yes</td>
            <td id="task-checkbox-${todo.id}"><i style="color:limegreen;" class="material-symbols-outlined" onclick="toggleDone('${todo.id}')">check_box</i></td>
          `;
        }
        else {
            tableRow.innerHTML += `
                <td id="done-${todo.id}">No</td>
                <td id="task-checkbox-${todo.id}"><i style="color:cadetblue;" class="material-symbols-outlined" onclick="toggleDone('${todo.id}')">check_box_outline_blank</i></td>`;
              }

        if(todo.date_completed) {
          tableRow.innerHTML += `
            <td id="task-completed-${todo.id}">${todo.date_completed}</td>
            <td id="task-time-taken-${todo.id}">${todo.time_taken}</td>`;
          }
        else {
          tableRow.innerHTML += `
            <td id="task-completed-${todo.id}">_</td>
            <td id="task-time-taken-${todo.id}">_</td>`;
          }
        
       
        table.appendChild(tableRow);
    }
}

async function main() {
    const todos = await getData();
    loadTable(todos);
} 

main();

async function makeTaskEditable(todoId) {
    const todoTextInput = document.getElementById(`task-${todoId}-input`);
    const todoEditButton = document.getElementById(`edit-button-${todoId}`);
    todoEditButton.innerHTML = `<a style="color: darkcyan;" class="material-symbols-outlined" onclick="editTask('${todoId}')">save</a>`;
    todoTextInput.contentEditable = true;
}

async function editTask(todoId) {
    const todoTextInput = document.getElementById(`task-${todoId}-input`);
    const todoText = todoTextInput.textContent;
    let todos = await getData();

    todos.forEach(todo => {
      if(todo.id === parseInt(todoId)) {
        todo.text = todoText;
      }
    });
    loadTable(todos);
    

    fetch(`/todos/${todoId}`, {
            method: 'PUT',

            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: todoId, text:todoText }),
            }).then(response => response.json())
                .then(data => {
                console.log("Received data:", data);  // check what’s coming from the backend
      
                if (data.success) {
                
                  } else {
                      alert("Update failed.");
                  }
                });
}



function enableCategoryDropdown(todoId) {
    const todoCategoryInput = document.getElementById(`task-${todoId}-category-dropdown`);
    const todoCategoryField = document.getElementById(`task-${todoId}-category`);
    const todoCategoryButton = document.getElementById(`enable-categories-${todoId}`);
    const todoCategoryContainer = document.querySelector(`#category-dropdown-${todoId}`);
    
    todoCategoryInput.disabled = false;
    todoCategoryContainer.style.display = 'block';
    todoCategoryField.querySelector('span').hidden = true;
    M.FormSelect.init(todoCategoryInput);
    todoCategoryButton.innerHTML = `<a style="color: skyblue;" class="material-symbols-outlined" onclick="changeCategory('${todoId}')">save</a>`;
}

async function changeCategory(todoId) {
    const todoCategoryInput = document.getElementById(`task-${todoId}-category-dropdown`);
    const todoCategory = todoCategoryInput.value;
    const todos = await getData();

    todos.forEach(todo => {
      if(todo.id === parseInt(todoId)) {
        todo.category = todoCategory;
      }
    })
    loadTable(todos);


        fetch(`/todos/${todoId}/change-category`, {
            method: 'PUT',

            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({category:todoCategory}),
            }).then(response => response.json())
                .then(data => {
                console.log("Received data:", data);  // check what’s coming from the backend
      
                if (data.success) {
            
                  } else {
                      alert("Update failed.");
                  }
                });
    }


  async function toggleDone(todoId) {
    const taskCheckbox = document.getElementById(`task-checkbox-${todoId}`);
    const taskDoneField = document.getElementById(`done-${todoId}`);
    const taskCompletedField = document.getElementById(`task-completed-${todoId}`);
    const taskTimeTakenField = document.getElementById(`task-time-taken-${todoId}`);

    fetch(`/todos/${todoId}/check`, {
        method: 'PUT',

        headers: {
            'Content-Type': 'application/json',
        },
        
        }).then(response => response.json())
            .then(data => {
            console.log("Received data:", data);  // check what’s coming from the backend
    
            if (data.success) {
                //console.log("Update successful");

                if(data.done) {
                    taskDoneField.innerHTML = `<span>Yes</span>`;
                    taskCheckbox.innerHTML = `<a style="color:limegreen;" class="material-symbols-outlined" onclick="toggleDone('${todoId}')">check_box</a>`;
                    taskCompletedField.innerHTML = `${data.date_completed}`;
                    taskTimeTakenField.innerHTML = `${data.time_taken}`;
                }
                else {
                    taskDoneField.innerHTML = `<span>No</span>`;
                    taskCheckbox.innerHTML = `<a style="color:cadetblue;" class="material-symbols-outlined" onclick="toggleDone('${todoId}')">check_box_outline_blank</a>`;
                    taskCompletedField.innerHTML = "_";
                    taskTimeTakenField.innerHTML = "_";
                }

            } else {
                    alert("Couldn't mark task as done.");
            }
        });
      }
</script>
  </body>
</html>

